# Experiment's Answers

Some entities are not available through BigDAWG's interface. These are due to implementation errors and they have already [been reported](#reported-issues).

# Methodology

I've followed the example setup, ran queries for every entity in [Kepler's data model](./Kepler.js) and copied the queries assembled by `polyflow's` from its logs. Then, I've extracted the raw SQL from BigDAWG's island context, i.e. removed the wrap `bdrel(...)` and queried the original data source for comparison.

- Special characters (e.g. `"`) are escaped by the logging library, however, it's been asserted that the request body is not escaped. For reproducibility purposes, you can use https://requestbin.com/ and change BigDAWG's endpoint for the one generated by the tool. Once you make a request, it'll showcase its body.

# Kepler data model

- `ProvONE's` **Port** ✅

  - Polyflow query:

  ```sql
    bdrel(select * from kepler[provone_port])
  ```

  - Assembled query:

  ```sql
    bdrel(
      select * from
        (
          SELECT
            p.id as port_id,CASE
              WHEN p.direction = 1 THEN 'out'
              WHEN p.direction = 0 THEN 'in'
            END as port_type,
            e.name as label
          FROM
            port as p
            INNER JOIN entity as e ON p.id = e.id
        ) as table_0
    )
  ```

  - BigDAWG's response:
    | id | case | name |
    |----|------|--------------------|
    | 22 | out | .Constant.output |
    | 23 | in | .Constant.trigger |
    | 30 | in | .Display.input |
    | 37 | out | .Constant2.output |
    | 38 | in | .Constant2.trigger |
    | 45 | out | .Constant3.output |
    | 46 | in | .Constant3.trigger |
    | 53 | out | .Constant4.output |
    | 54 | in | .Constant4.trigger |
    | 61 | out | .Constant5.output |
    | 62 | in | .Constant5.trigger |

  - Expected response:
    | port_id | port_type | label |
    |---------|-----------|--------------------|
    | 22 | out | .Constant.output |
    | 23 | in | .Constant.trigger |
    | 30 | in | .Display.input |
    | 37 | out | .Constant2.output |
    | 38 | in | .Constant2.trigger |
    | 45 | out | .Constant3.output |
    | 46 | in | .Constant3.trigger |
    | 53 | out | .Constant4.output |
    | 54 | in | .Constant4.trigger |
    | 61 | out | .Constant5.output |
    | 62 | in | .Constant5.trigger |

- `Prov's` **Entity** ❌

  - Polyflow query:

  ```sql
    bdrel(select * from kepler[prov_entity])
  ```

  - Assembled query:

  ```sql
    bdrel(
      select * from
        (
          (
            SELECT * FROM
              (
                (
                  SELECT
                    param.id as entity_id,
                    param.type as type,
                    param.value as value,
                    'provone_Data' as entity_type,
                    e.name as label
                  FROM
                    parameter as param
                    INNER JOIN entity as e ON param.id = e.id
                )
              ) as table_0
          )
          UNION ALL
            (
              SELECT * FROM
                (
                  (
                    SELECT
                      0 as entity_id,
                      'md5' as type,
                      d.md5 as value,
                      'provone_Data' as entity_type,
                      ad.name as label
                    FROM
                      data as d
                      LEFT JOIN associated_data as ad ON d.md5 = ad.data_id
                  )
                ) as table_1
            )
        ) as table_2
     )
  ```

  - BigDAWG's response: `"ERROR: relation \"null\" does not exist": " Position: 156"`

  - Expected response:
    | entity_id | type | value | entity_type | label |
    | --- | --- | ---- | ---- | --- |
    | 0 | md5 | 3efa76b06a6ecf6b51f45e43fc9d5d53 | provone_Data | null

- `ProvONE's` **Program** ❌

  - Polyflow query:

  ```sql
    bdrel(select * from kepler[provone_program])
  ```

  - Assembled query:

  ```sql
    bdrel(
      select * from
        (
          SELECT
            program_id as program_id,
            label as label,
            ipw as is_provone_Workflow,
            phssubp as provone_hasSubProgram
          FROM
            (
              (
                SELECT
                  a.id as program_id
                FROM
                  actor as a
              )
            ) as t1
            INNER JOIN (
              (
                SELECT
                  e.id as joinId,
                  COALESCE(w.name, e.name) as label,CASE
                    WHEN w.id IS NOT NULL THEN TRUE
                    ELSE FALSE
                  END as ipw,CASE
                    WHEN w.id IS NOT NULL THEN NULL
                    ELSE e.wf_id
                  END as phssubp
                FROM
                  entity as e
                  LEFT JOIN workflow as w ON w.id = e.id
              )
            ) as t2 ON program_id = joinId
        ) as table_5
    )
  ```

  - BigDAWG's response: `ø`

  - Expected response:
    | program_id | label | is_provone_workflow | provone_hassubprogram |
    |------------|---------------|---------------------|-----------------------|
    | 1 | 04-HelloWorld | true | |
    | 16 | .Constant | false | 1 |
    | 24 | .Display | false | 1 |
    | 31 | .Constant2 | false | 1 |
    | 39 | .Constant3 | false | 1 |
    | 47 | .Constant4 | false | 1 |
    | 55 | .Constant5 | false | 1 |

- `ProvONE's` **Execution** ❌

  - Polyflow query:

  ```sql
    bdrel(select * from kepler[provone_execution])
  ```

  - Assembled query:

  ```sql
    bdrel(
      select * from (
        (
          SELECT
            af.id as execution_id,
            af.start_time as prov_startedAtTime,
            af.end_time as prov_endedAtTime,
            af.wf_exec_id as provone_wasPartOf,
            NULL as prov_wasAssociatedWith
          FROM
            actor_fire as af
        )
        UNION ALL
        (
          SELECT
            NULL as execution_id,
            wfe.start_time as prov_startedAtTime,
            wfe.end_time as prov_endedAtTime,
            wfe.wf_id as provone_wasPartOf,
            wfe."USER" as prov_wasAssociatedWith FROM workflow_exec as wfe
        )
      ) as table_1
    )
  ```

  - BigDAWG's response: `cannot find: wfe.\"USER\"; finder: \"USER\"; srcSchema: {annotation=workflow_exec.annotation:character varying, wf_contents_id=workflow_exec.wf_contents_id:character varying, end_time=workflow_exec.end_time:timestamp, type=workflow_exec.type:character varying, host_id=workflow_exec.host_id:character varying, lsid=workflow_exec.lsid:character varying, start_time=workflow_exec.start_time:timestamp, module_dependencies=workflow_exec.module_dependencies:character varying, wf_id=workflow_exec.wf_id:integer, derived_from=workflow_exec.derived_from:character varying, wf_full_lsid=workflow_exec.wf_full_lsid:character varying, id=workflow_exec.id:integer, USER=workflow_exec.USER:character varying}`

  - Expected response:
    | execution_id | prov_startedattime | prov_endedattime | provone_waspartof | prov_wasassociatedwith |
    |--------------|--------------------------|--------------------------|-------------------|------------------------|
    | 1 | 2018-08-12T18:23:11.025Z | 2018-08-12T18:23:11.026Z | 1 | |
    | 2 | 2018-08-12T18:23:11.027Z | 2018-08-12T18:23:11.028Z | 1 | |
    | 3 | 2018-08-12T18:23:11.028Z | 2018-08-12T18:23:11.029Z | 1 | |
    | 4 | 2018-08-12T18:23:11.029Z | 2018-08-12T18:23:11.029Z | 1 | |
    | 5 | 2018-08-12T18:23:11.030Z | 2018-08-12T18:23:11.031Z | 1 | |
    | 6 | 2018-08-12T18:23:11.031Z | 2018-08-12T18:23:11.034Z | 1 | |
    | | 2018-08-12T18:23:10.983Z | 2018-08-12T18:23:11.034Z | 1 | yanmendes |

- `Prov's` **Association** ❌

  - Polyflow query:

  ```sql
    bdrel(select * from kepler[prov_association])
  ```

  - Assembled query:

  ```sql
    bdrel(
      select
        *
      from
        (
          (
            SELECT
              af.id as execution_id,
              actor_id as prov_hadPlan
            FROM
              actor_fire as af
          )
          UNION ALL
            (
              SELECT
                NULL as execution_id,
                wfe.wf_id as prov_hadPlan
              FROM
                workflow_exec as wfe
            )
        ) as table_3
    )
  ```

  - BigDAWG's response: `net.sf.jsqlparser.statement.select.SetOperationList cannot be cast to net.sf.jsqlparser.statement.select.PlainSelect`

  - Expected response:
    | execution_id | prov_hadplan |
    |--------------|--------------|
    | 1 | 55 |
    | 2 | 47 |
    | 3 | 39 |
    | 4 | 31 |
    | 5 | 16 |
    | 6 | 24 |
    | | 1 |

- `Prov's` **Usage** ✅

  - Polyflow query:

  ```sql
    bdrel(select * from kepler[prov_usage])
  ```

  - Assembled query:

  ```sql
    bdrel(
      select * from
        (
          SELECT
            pe.fire_id as execution_id,
            pe.port_id as provone_hadInPort,
            data as data
          FROM
            port_event as pe
          WHERE
            pe.write_event_id = -1
        ) as table_4
    )
  ```

  - BigDAWG's response:
    | execution_id | provone_hadinport | data |
    |--------------|-------------------|----------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------|
    | 1 | 61 | "Scenester artisan four loko thundercats salvia jean shorts gentrify sustainable hoodie." |
    | 2 | 53 | "Salvia butcher dreamcatcher american apparel Austin portland fixie keffiyeh 8-bit." |
    | 3 | 45 | "Keytar mustache quinoa farm-to-table brunch DIY skateboard fixie iphone blog." |
    | 4 | 37 | "Tattooed fap lo-fi food truck locavore salvia keffiyeh master cleanse butcher synth DIY." |
    | 5 | 22 | "DIY squid leggings brooklyn bicycle rights synth vinyl freegan wayfarers gluten-free you probably haven't heard of them beard viral." |

  - Expected response:
    | execution_id | provone_hadinport | data |
    |--------------|-------------------|----------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------|
    | 1 | 61 | "Scenester artisan four loko thundercats salvia jean shorts gentrify sustainable hoodie." |
    | 2 | 53 | "Salvia butcher dreamcatcher american apparel Austin portland fixie keffiyeh 8-bit." |
    | 3 | 45 | "Keytar mustache quinoa farm-to-table brunch DIY skateboard fixie iphone blog." |
    | 4 | 37 | "Tattooed fap lo-fi food truck locavore salvia keffiyeh master cleanse butcher synth DIY." |
    | 5 | 22 | "DIY squid leggings brooklyn bicycle rights synth vinyl freegan wayfarers gluten-free you probably haven't heard of them beard viral." |

- `Prov's` **Generation** ✅

  - Polyflow query:

  ```sql
    bdrel(select * from kepler[prov_generation])
  ```

  - Assembled query:

  ```sql
    bdrel(
      select * from
        (
          SELECT
            pe.fire_id as execution_id,
            pe.port_id as provone_hadInPort,
            data as data
          FROM
            port_event as pe
          WHERE
            pe.write_event_id != -1
        ) as table_7
    )
  ```

  - BigDAWG's response:
    | execution_id | provone_hadinport | data |
    |--------------|-------------------|------|
    | 6 | 30 | |
    | 6 | 30 | |
    | 6 | 30 | |
    | 6 | 30 | |
    | 6 | 30 | |

  - Expected response:
    | execution_id | provone_hadinport | data |
    |--------------|-------------------|------|
    | 6 | 30 | |
    | 6 | 30 | |
    | 6 | 30 | |
    | 6 | 30 | |
    | 6 | 30 | |

- `ProvONE's` **User** ❌

  - Polyflow query:

  ```sql
    bdrel(select * from kepler[provone_user])
  ```

  - Assembled query:

  ```sql
    bdrel(
      select
        *
      from
        (
          SELECT
            we."USER" as label,we.wf_id as program_id FROM workflow_exec as we
        ) as table_2
    )
  ```

  - BigDAWG's response: `"cannot find: we."USER"; finder: "USER"; srcSchema: {annotation=workflow_exec.annotation:character varying, wf_contents_id=workflow_exec.wf_contents_id:character varying, end_time=workflow_exec.end_time:timestamp, type=workflow_exec.type:character varying, host_id=workflow_exec.host_id:character varying, lsid=workflow_exec.lsid:character varying, start_time=workflow_exec.start_time:timestamp, module_dependencies=workflow_exec.module_dependencies:character varying, wf_id=workflow_exec.wf_id:integer, derived_from=workflow_exec.derived_from:character varying, wf_full_lsid=workflow_exec.wf_full_lsid:character varying, id=workflow_exec.id:integer, USER=workflow_exec.USER:character varying}`

  - Expected response:
    | label | program_id |
    |--------|------------------- |
    | yanmendes | 1 |

# Reported issues

- https://github.com/bigdawg-istc/bigdawg/issues/15
- https://github.com/bigdawg-istc/bigdawg/issues/16
- https://github.com/bigdawg-istc/bigdawg/issues/17
